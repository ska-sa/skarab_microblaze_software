# SKARAB Microblaze Software

This repository contains the C code required to build an elf file for the Microblaze
running on the SKARAB platform and forms part of the broader SKARAB firmware and
toolflow infrastructure.

## Setting up the build environment:

Requirements: Xilinx Vivado and SDK, zenity (optional), dialog (optional)

1.  Run the configure script from the top directory:

    `% ./configure`

    Usage: ./configure [--help] [--force] [--gui <none|zenity|dialog>]

	  The script will attempt to use the zenity or dialog utilities to render a gui. If
	  these are unavailable, a command line input prompt will be given.

2.  Enter or select the path to the top-level directory of the SDK install i.e.`<path/to/xilinx/install>/SDK/<install/version>`

	  NOTE: this script relies on the Xilinx install naming conventions. It will attempt to
	  find all installed versions if a higher-level dir is chosen, for e.g. '/'. In this
	  case, the search may also yield results of Xilinx directories which have the same
	  structure but are metadata directories e.g.  ~/.Xilinx/SDK/<install/version>.  These
	  should not be selected as the installation path.

3.  Select the desired installation version from the listed installations found.

Upon successful completion, this script will generate the Makefile.inc file. This
file contains variables pointing to the paths required for the build process and
will be used by the make utility during compilation.

Also generated by the configure script, are the Microblaze bsp libraries.

On occassion it may be necessary to rerun the ./configure script. An example of this
is when the Microblaze subsystem in the firmware design changes, in turn changing the
.hdf file. This generally requires a rebuild of the bsp libraries.  Since the build
environment is already set up, the --force option can be used to force a rebuild.


## Building the elf

Once the build environment has been set up, simply run

    % make

This will compile the source code and generate the elf file in the elf/ dir.

## Release software versioning

The convention used to generate the relese version number is as follows:
<MAJOR>.<YEAR>.<DAY_OF_YEAR>

## Directory Structure:
```
.
|
+ configure                    -> run this script first (and usually once, unless
|                                 paths change) to configure the make environment.
|                                 Optional Dependencies: zenity, dialog
|                                 Output: Makefile.inc
|
+ bsp/                         -> contains the tcl scripts used by ./configure to
|   |                             set up the build environment as well as some
|   |                             generated build outputs.
|   |
|   +--skarab_microblaze_bsp/  -> directory containing the bsp libraries generated
|                                 after ./configure script has been run.
|
+ doc/                         -> notes and documentation
|
+ src/                         -> directory containing Microblaze application
|                                 source/header/linker files.
|
+ output/                      -> directory containing compiler generated auxiliary
|                                 files (only created after first make build).
|
+ elf/                         -> directory containing the built elf file(s)
|                                 (only created after first make build).
|
+ utils/                       -> contains source for a small utility called adler32
|                                 used to generate the checksum for the memory test
|                                 run at Microblaze bootup. This is automatically
|                                 generated by the build scripts.
|
+ Makefile                     -> used by make to build the elf file.
|                                 Dependencies: src/, Makefile.inc, Makefile.config
|                                 Output: EMB123701U1R1-*.elf; output/*.[od]
|                                 make targets: all, clean, copy
|
+ Makefile.inc                 -> Contains host specific build paths and is generated
|                                 by ./configure script.
|
+ Makefile.config              -> Contains various options used to configure the
                                  source code during elf generation.
```

## Build options

Various codebase features can be enabled/disabled by the options listed in
Makefile.config.


## Related repositories

* [ska-sa/casperfpga](https://github.com/ska-sa/casperfpga) is a python library used to interact and interface with CASPER Hardware such as the SKARAB. This specific repo is maintained by SARAO.
* [ska-sa/mlib_devel](https://github.com/ska-sa/mlib_devel) is the CASPER Toolflow repository. This specific repo is maintained by SARAO and is used to build SKARAB images.

